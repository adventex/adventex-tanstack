import{G as j,H as u,J as T,K as F,N as m,O as S}from"./client-B42ABy-e.js";function b(e){return e instanceof Headers?new Headers(e):Array.isArray(e)?new Headers(e):typeof e=="object"?new Headers(e):new Headers}function E(...e){return e.reduce((t,n)=>{const r=b(n);for(const[a,o]of r.entries())t.set(a,o);return t},new Headers)}const H=[];function y(e,t){const n=t||e||{};return typeof n.method>"u"&&(n.method="GET"),{options:n,middleware:r=>y(void 0,Object.assign(n,{middleware:r})),validator:r=>y(void 0,Object.assign(n,{validator:r})),handler:(...r)=>{const[a,o]=r;Object.assign(n,{...a,extractedFn:a,serverFn:o}),j(a.url);const s=[...n.middleware||[],C(n)];return Object.assign(async i=>v(s,"client",{...a,method:n.method,data:i?.data,headers:i?.headers,context:Object.assign({},a)}).then(c=>c.result),{...a,__executeServer:i=>{const c=i instanceof FormData?N(i):i;return v(s,"server",{...a,...c}).then(d=>({result:d.result,context:d.sendContext}))}})}}}function N(e){const t=e.get("__TSR_CONTEXT");if(e.delete("__TSR_CONTEXT"),typeof t!="string")return{context:{},data:e};try{return{context:u.parse(t),data:e}}catch{return{data:e}}}function M(e){const t=new Set,n=[],r=a=>{a.forEach(o=>{o.options.middleware&&r(o.options.middleware),t.has(o)||(t.add(o),n.push(o))})};return r(e),n}const p=(e,t,n)=>e({data:t.data,context:t.context,sendContext:t.sendContext,method:t.method,next:r=>{const a={...t.context,...r?.context},o={...t.sendContext,...r?.sendContext??{}},s=E(t.headers,r?.headers);return n({method:t.method,data:t.data,context:a,sendContext:o,headers:s,result:r?.result??t.result})}});function $(e,t){if(e==null)return{};if("~standard"in e){const n=e["~standard"].validate(t);if(n instanceof Promise)throw new Error("Async validation not supported");if(n.issues)throw new Error(JSON.stringify(n.issues,void 0,2));return n.value}if("parse"in e)return e.parse(t);if(typeof e=="function")return e(t);throw new Error("Invalid validator type!")}async function v(e,t,n){const r=M([...H,...e]),a=async o=>{const s=r.shift();if(!s)return o;s.options.validator&&(t!=="client"||s.options.validateClient)&&(o.data=await $(s.options.validator,o.data));const i=t==="client"?s.options.client:s.options.server;return i?p(i,o,async c=>{if(t==="client"&&s.options.clientAfter){const d=await a(c);return p(s.options.clientAfter,d,h=>h)}return a(c)}):a(o)};return a({...n,headers:n.headers||{},sendContext:n.sendContext||{},context:n.context||{}})}function C(e){return{_types:void 0,options:{validator:e.validator,validateClient:e.validateClient,client:async({next:t,sendContext:n,...r})=>{var a;const o=await((a=e.extractedFn)==null?void 0:a.call(e,{...r,context:n}));return t(o)},server:async({next:t,...n})=>{var r;const a=await((r=e.serverFn)==null?void 0:r.call(e,n));return t({result:a})}}}}async function I(e,t,n){var r;const a=t[0];if(T(a)&&a.method){const d=a,h=d.data instanceof FormData?"formData":"payload",g=new Headers({...h==="payload"?{"content-type":"application/json",accept:"application/json"}:{},...d.headers instanceof Headers?Object.fromEntries(d.headers.entries()):d.headers||{}});if(d.method==="GET"){const l=F({payload:u.stringify({data:d.data,context:d.context})});l&&(e+=`&${l}`)}const O=new Request(e,{method:d.method,headers:g,...J(d)}),_=await n(O),w=await x(_);if((r=w.headers.get("content-type"))!=null&&r.includes("application/json")){const l=await w.text(),f=l?u.parse(l):void 0;if(m(f)||S(f))throw f;return f}return w}const o=new Request(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}),s=await x(await n(o)),i=s.headers.get("content-type"),c=await s.text();return i&&i.includes("application/json")?c?JSON.parse(c):void 0:c}function J(e){return e.method==="POST"?e.data instanceof FormData?(e.data.set("__TSR_CONTEXT",u.stringify(e.context)),{body:e.data}):{body:u.stringify({data:e.data??null,context:e.context})}:{}}async function x(e){if(!e.ok){const t=e.headers.get("content-type"),n=t&&t.includes("application/json"),r=await(async()=>n?await e.json():await e.text())(),a=`Request failed with status ${e.status}`;throw n?new Error(JSON.stringify({message:a,body:r})):new Error([a,`${JSON.stringify(r,null,2)}`].join(`

`))}return e}function q(e){return e.replace(/^\/|\/$/g,"")}function A(e,t,n){return`${e}/${q("/_server")}/?_serverFnId=${encodeURI(t)}&_serverFnName=${encodeURI(n)}`}function P(e,t,n){const r=A(window.location.origin,t,n);return Object.assign((...o)=>I(r,o,fetch),{url:r,filename:t,functionId:n})}export{P as a,y as c};
